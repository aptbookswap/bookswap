{% extends "base.html" %}
{% load static %}

{% block title %}Inicio | BookSwap{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock %}


{% block content %}
<section id="inicio" class="hero-section text-center">
    <div class="container">
        <h1 class="display-4 fw-bold">Intercambia, vende o dona libros</h1>
        <p class="lead">Encuentra lectores cerca de ti y dale una nueva vida a tus libros</p>
        <div class="mt-4">
            <a href="#registro" class="btn btn-primary btn-lg me-2">Empieza ahora</a>
            <a href="#como-funciona" class="btn btn-outline-light btn-lg">Cómo funciona</a>
        </div>
    </div>
</section>

<section id="mapa" class="container mb-5">
    <h2 class="text-center mb-4">Libros en tu zona</h2>
    <div class="map-container">
        <div id="mapLoginOverlay" class="map-overlay login-required">
            <div class="map-content">
                <i class="fas fa-lock fa-4x mb-3"></i>
                <h3>Acceso restringido</h3>
                <p>Debes iniciar sesión para ver los libros disponibles en tu zona</p>
                <button id="mapLoginBtn" class="btn btn-primary mt-3">Iniciar sesión</button>
                <div class="mt-3 text-muted">
                    <small>Usuario demo: admin@bookswap.com / admin</small>
                </div>
            </div>
        </div>
        <div id="realMap" style="display: none; width: 100%; height: 100%;">
            <div style="width: 100%; height: 100%; display: flex; flex-direction: column;">
                <div class="bg-primary text-white p-2 d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-map-marked-alt me-2"></i>
                        <span>Mapa de libros disponibles</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-light me-2">
                            <i class="fas fa-filter"></i> Filtros
                        </button>
                        <button class="btn btn-sm btn-light">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>
                <div id="map" style="flex-grow: 1;"></div>
            </div>
        </div>
    </div>
</section>

<section id="como-funciona" class="bg-light py-5 mb-5">
    <div class="container">
        <h2 class="text-center mb-5">Cómo funciona BookSwap</h2>
        <div class="row text-center">
            <div class="col-md-4 mb-4">
                <div class="feature-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h3>1. Regístrate</h3>
                <p>Crea tu perfil en minutos y configura tus preferencias literarias.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="feature-icon">
                    <i class="fas fa-book-open"></i>
                </div>
                <h3>2. Sube tus libros</h3>
                <p>Agrega los libros que quieras intercambiar, vender o donar.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="feature-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <h3>3. Conecta</h3>
                <p>Encuentra otros lectores y coordina el intercambio.</p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script>
    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
    const mapLoginOverlay = document.getElementById('mapLoginOverlay');
    const realMap = document.getElementById('realMap');
    const authButtons = document.getElementById('authButtons');
    const userMenu = document.getElementById('userMenu');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');

    const demoUser = {
        email: 'admin@bookswap.com',
        password: 'admin',
        name: 'Administrador',
        avatar: 'https://randomuser.me/api/portraits/men/1.jpg'
    };

    let map = null;
    let geolocate = null;
    let userLocation = null;
    let destinationMarker = null;
    let destinationPopup = null;
    const routeLayerId = 'route';

    document.getElementById('loginBtn').addEventListener('click', () => loginModal.show());
    document.getElementById('mapLoginBtn').addEventListener('click', () => loginModal.show());
    document.getElementById('registerBtn').addEventListener('click', () => alert('Redirigiendo al formulario de registro'));
    document.getElementById('heroRegisterBtn').addEventListener('click', () => alert('Redirigiendo al formulario de registro'));

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        if(email === demoUser.email && password === demoUser.password) {
            loginModal.hide();
            mapLoginOverlay.style.display = 'none';
            realMap.style.display = 'block';
            authButtons.classList.add('d-none');
            userMenu.classList.remove('d-none');
            document.getElementById('userAvatar').src = demoUser.avatar;
            userEmailDisplay.textContent = demoUser.email;
            if (!map) initMap();
        } else {
            alert('Credenciales incorrectas. Usa admin@bookswap.com / admin');
        }
    });

    logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        authButtons.classList.remove('d-none');
        userMenu.classList.add('d-none');
        mapLoginOverlay.style.display = 'flex';
        realMap.style.display = 'none';
        loginForm.reset();
        alert('Has cerrado sesión correctamente');
    });

    function initMap() {
        mapboxgl.accessToken = 'pk.eyJ1IjoiY2hjYW5lbyIsImEiOiJjbThuNmZpYjQwbjBmMmpwd3M1aXc1N21vIn0.z40V0PC46BKyTYipeK4Uqw';
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/outdoors-v12',
            zoom: 5
        });

        geolocate = new mapboxgl.GeolocateControl({ trackUserLocation: false, showUserLocation: true });
        map.addControl(geolocate);

        geolocate.on('geolocate', (e) => {
            userLocation = [e.coords.longitude, e.coords.latitude];
            map.flyTo({ center: userLocation, zoom: 13 });
        });

        map.on('load', () => geolocate.trigger());

        map.on('contextmenu', (e) => {
            if (destinationMarker) destinationMarker.remove();
            if (destinationPopup) destinationPopup.remove();

            destinationMarker = new mapboxgl.Marker().setLngLat([e.lngLat.lng, e.lngLat.lat]).addTo(map);
            destinationPopup = new mapboxgl.Popup().setLngLat([e.lngLat.lng, e.lngLat.lat]).setHTML('Libro 123 - Luis Perez').addTo(map);

            if (userLocation) getDirections(userLocation, [e.lngLat.lng, e.lngLat.lat]);
        });

        map.addControl(new mapboxgl.NavigationControl());
    }

    function getDirections(start, end) {
        const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`;
        fetch(url)
            .then(res => res.json())
            .then(data => drawRoute(data.routes[0].geometry))
            .catch(() => removeRoute());
    }

    function drawRoute(geometry) {
        removeRoute();
        map.addSource('route', {
            'type': 'geojson',
            'data': { 'type': 'Feature', 'geometry': geometry }
        });
        map.addLayer({
            'id': routeLayerId,
            'type': 'line',
            'source': 'route',
            'layout': { 'line-join': 'round', 'line-cap': 'round' },
            'paint': { 'line-color': '#3887be', 'line-width': 5 }
        });
    }

    function removeRoute() {
        if (map.getLayer(routeLayerId)) map.removeLayer(routeLayerId);
        if (map.getSource('route')) map.removeSource('route');
    }
</script>
{% endblock %}
